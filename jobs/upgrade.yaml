- job:
    name: 'upgrade'
    description: 'Upgrade Spinal Stack'
    project-type: freestyle
    wrappers:
      - ansicolor:
          colormap: xterm
    builders:
      - shell: |
          set -e
          export ANSIBLE_HOST_KEY_CHECKING=false
          for template in site.yml hosts group_vars/all; do
            generate.py 0 /etc/config-tools/global.yml /etc/ansible/$template.tmpl|grep -v '^$' |sudo tee /etc/ansible/$template > /dev/null
            sudo chmod 0644 /etc/ansible/$template
          done
          ansible-playbook -s -M /srv/edeploy/ansible/library /etc/ansible/site.yml -v --tags "install_server"
          ansible-playbook -s -M /srv/edeploy/ansible/library /etc/ansible/site.yml -v --tags "before_config"
          ansible-playbook -s -M /srv/edeploy/ansible/library /etc/ansible/site.yml -v --tags "galera_synced"
          echo '0' | sudo tee /etc/config-tools/step
          configure.sh 0
          echo '5' | sudo tee /etc/config-tools/step
          configure.sh 5
          ansible-playbook -s -M /srv/edeploy/ansible/library /etc/ansible/site.yml -v --tags "after_config"
          ret=$?
          exit $ret
